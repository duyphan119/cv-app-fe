import Head from "next/head";
import React from "react";
import { DefaultLayout } from "../../layouts";
import styles from "../../styles/Cart.module.css";
import { Container, IconButton } from "@mui/material";
import { useCartContext } from "../../context/CartContext";
import Image from "next/image";
import DeleteOutlineIcon from "@mui/icons-material/DeleteOutline";
import Link from "next/link";
import emptyCartPng from "../../public/empty-cart.png";

type Props = {};

type CartItemProps = {
  item: any;
};

const CartItem = React.memo((props: CartItemProps) => {
  const { updateCart, deleteItem } = useCartContext();

  const handleUpdateItem = (newQuantity: number) => {
    updateCart({ ...props.item, quantity: newQuantity });
  };

  const handleDeleteItem = () => {
    deleteItem(props.item.productVariant.id);
  };

  return (
    <tr>
      <td>
        <div className={styles["td-product"]}>
          <div>
            <Image
              width={72}
              height={72}
              priority={true}
              alt=""
              src={props.item.productVariant.product.thumbnail}
            />
          </div>
          <div>
            <Link
              href={{
                pathname: "/san-pham/[slug]",
                query: { slug: props.item.productVariant.product.slug },
              }}
            >
              {props.item.productVariant.product.name}
            </Link>
            {props.item.productVariant.variants.map((variant: any) => {
              return (
                <div key={variant.id} className={styles.variant}>
                  {variant.type}: {variant.name}
                </div>
              );
            })}
          </div>
        </div>
      </td>
      <td>{props.item.productVariant.price}</td>
      <td>
        <div className={styles.quantity}>
          <button
            className={styles.inc}
            onClick={() => handleUpdateItem(props.item.quantity - 1)}
          >
            -
          </button>
          {props.item.quantity}
          <button
            className={styles.desc}
            onClick={() => handleUpdateItem(props.item.quantity + 1)}
          >
            +
          </button>
        </div>
      </td>
      <td>{props.item.quantity * props.item.productVariant.price}</td>
      <td>
        <IconButton color="error" onClick={handleDeleteItem}>
          <DeleteOutlineIcon />
        </IconButton>
      </td>
    </tr>
  );
});

const TableCart = () => {
  const { cart, total } = useCartContext();
  return cart ? (
    <table className={styles["table-cart"]}>
      <thead>
        <tr>
          <th>Sản phẩm</th>
          <th>Giá</th>
          <th>Số lượng</th>
          <th>Tổng</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {cart.items.map((item: any) => {
          return <CartItem key={item.productVariant.id} item={item} />;
        })}
        <tr>
          <td colSpan={3}>
            <div className={styles.coupon}>
              <input placeholder="Nhập mã giảm giá" />
              <button>Sử dụng</button>
            </div>
          </td>
          <td>{total}</td>
          <td></td>
        </tr>
      </tbody>
    </table>
  ) : null;
};

const CartResult = () => {
  const { total } = useCartContext();
  return (
    <div className={styles["cart-result"]}>
      <div className={styles.row}>
        <span>Giá gốc</span>
        <span>{total}</span>
      </div>
      <div className={styles.row}>
        <span>Tổng cộng</span>
        <span>{total}</span>
      </div>
      <Link href="/thanh-toan" className={styles.checkout}>
        Thanh toán
      </Link>
    </div>
  );
};

const EmptyCart = () => {
  return (
    <div className={styles.empty}>
      <div>
        <Image
          src={emptyCartPng}
          alt=""
          width={360}
          height={360}
          priority={true}
        />
      </div>
      <p>Giỏ hàng của bạn đang trống</p>
      <Link href="/san-pham">Xem tất cả sản phẩm</Link>
    </div>
  );
};

const Cart = (props: Props) => {
  const { count } = useCartContext();
  return (
    <DefaultLayout>
      <>
        <Head>
          <title>Giỏ hàng</title>
          <meta name="description" content="Generated by create next app" />
          <link rel="icon" href="/favicon.ico" />
        </Head>

        <main className={styles.main}>
          {count ? (
            <Container maxWidth="lg">
              <h1>Giỏ hàng của bạn</h1>
              <TableCart />
              <CartResult />
            </Container>
          ) : (
            <EmptyCart />
          )}
        </main>
      </>
    </DefaultLayout>
  );
};

export default Cart;
